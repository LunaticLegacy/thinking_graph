<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title data-i18n="appTitle">Thinking Graph</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="backdrop" aria-hidden="true"></div>
    <header class="topbar fade-in">
        <div class="topbar-left">
            <p class="eyebrow" data-i18n="header.title">Thinking Graph</p>
            <h1 data-i18n="header.subtitle">Opinion Node Relationship Map</h1>
            <div class="language-switcher" role="group">
                <span class="language-label" data-i18n="language.label">Interface Language</span>
                <select id="language-selector" data-i18n-aria-label="language.ariaLabel">
                    <option value="zh" data-i18n="language.options.zh">Simplified Chinese</option>
                    <option value="en" data-i18n="language.options.en">English</option>
                </select>
            </div>
        </div>
        <button id="refresh-all" class="btn btn-secondary" data-i18n="header.refresh">Refresh</button>
    </header>

    <main class="layout">
        <section class="panel fade-in delay-1">
            <h2 data-i18n="nodePanel.title">Add Opinion Node</h2>
            <form id="node-form" class="stacked-form">
                <label>
                    <span data-i18n="nodePanel.contentLabel">Opinion Content</span>
                    <textarea id="node-content" required data-i18n-placeholder="nodePanel.contentPlaceholder" placeholder="For example: Remote work can improve deep work efficiency"></textarea>
                </label>
                <label>
                    <span data-i18n="nodePanel.summaryLabel">Brief Summary</span>
                    <input id="node-summary" type="text" data-i18n-placeholder="nodePanel.summaryPlaceholder" placeholder="For example: Remote work improves efficiency">
                </label>
                <div class="dual-field-row">
                    <label>
                        <span data-i18n="nodePanel.confidenceLabel">Confidence (0~1)</span>
                        <input id="node-confidence" type="number" min="0" max="1" step="0.1" value="1">
                    </label>
                    <label>
                        <span data-i18n="nodePanel.colorLabel">Node Color</span>
                        <input id="node-color" type="color" value="#157f83">
                    </label>
                </div>
                <button type="submit" class="btn" data-i18n="nodePanel.createBtn">Create Node</button>
                <p id="node-form-mode">创建节点请使用此表单；选中节点后，提交表单会更新该节点属性。</p>
            </form>

            <h2 data-i18n="connectionPanel.title">Create Connection</h2>
            <form id="connection-form" class="stacked-form">
                <label>
                    <span data-i18n="connectionPanel.sourceLabel">Source Opinion</span>
                    <select id="source-node" required></select>
                </label>
                <label>
                    <span data-i18n="connectionPanel.targetLabel">Target Opinion</span>
                    <select id="target-node" required></select>
                </label>
                <label>
                    <span data-i18n="connectionPanel.typeLabel">Relationship Type</span>
                    <select id="conn-type">
                        <option value="supports" data-i18n="connectionPanel.types.supports">Supports</option>
                        <option value="opposes" data-i18n="connectionPanel.types.opposes">Opposes</option>
                        <option value="relates" data-i18n="connectionPanel.types.relates">Relates</option>
                        <option value="leads_to" data-i18n="connectionPanel.types.leads_to">Leads To</option>
                        <option value="derives_from" data-i18n="connectionPanel.types.derives_from">Derives From</option>
                    </select>
                </label>
                <label>
                    <span data-i18n="connectionPanel.descriptionLabel">Relationship Description</span>
                    <input id="conn-description" type="text" data-i18n-placeholder="connectionPanel.descriptionPlaceholder" placeholder="For example: A serves as a prerequisite for B">
                </label>
                <button type="submit" class="btn" data-i18n="connectionPanel.createBtn">Create Connection</button>
            </form>

            <div class="stack-inline">
                <button id="delete-node" class="btn btn-danger" data-i18n="actionButtons.deleteNode">Delete Selected Node</button>
                <button id="delete-connection" class="btn btn-danger" data-i18n="actionButtons.deleteConnection">Delete Selected Connection</button>
                <button id="update-node-color" class="btn btn-secondary" data-i18n="actionButtons.updateColor">Update Selected Node Color</button>
                <button id="tidy-graph" class="btn btn-secondary" data-i18n="actionButtons.tidyGraph">Tidy Layout</button>
            </div>

            <h2 data-i18n="saveLoadPanel.title">Save/Load Thinking Graph</h2>
            <form id="graph-save-form" class="stacked-form">
                <label>
                    <span data-i18n="saveLoadPanel.nameLabel">Snapshot Name</span>
                    <input id="save-graph-name" type="text" data-i18n-placeholder="saveLoadPanel.namePlaceholder" placeholder="For example: Discussion Version-v1" required>
                </label>
                <button type="submit" class="btn btn-secondary" data-i18n="saveLoadPanel.saveBtn">Save Current Graph</button>
            </form>
            <div class="stack-inline">
                <select id="saved-graphs"></select>
                <button id="load-graph" type="button" class="btn btn-secondary" data-i18n="saveLoadPanel.loadBtn">Load Selected Graph</button>
                <button id="refresh-saved" type="button" class="btn btn-secondary" data-i18n="saveLoadPanel.refreshListBtn">Refresh List</button>
                <button id="delete-saved-graph" type="button" class="btn btn-danger" data-i18n="saveLoadPanel.deleteBtn">Delete Saved Graph</button>
                <button id="clear-graph" type="button" class="btn btn-danger" data-i18n="saveLoadPanel.clearBtn">Clear Current Graph</button>
            </div>
            <div class="stack-inline">
                <button id="export-graph" type="button" class="btn btn-secondary" data-i18n="saveLoadPanel.exportJson">Export JSON</button>
                <button id="import-graph" type="button" class="btn btn-secondary" data-i18n="saveLoadPanel.importJson">Import JSON</button>
                <input id="import-graph-file" type="file" accept=".json,application/json" hidden>
            </div>
        </section>

        <div class="canvas-stack fade-in delay-2">
            <section class="panel canvas-panel">
                <div class="canvas-head">
                    <h2 data-i18n="canvasPanel.title">Graph Canvas</h2>
                    <p id="selection-tip">点击节点可编辑；创建节点请使用左侧表单。</p>
                </div>
                <div id="network"></div>
            </section>

            <section class="panel settings-panel">
                <h2 data-i18n="settingsPanel.title">设置（app_config）</h2>
                <form id="settings-form" class="stacked-form">
                    <fieldset class="settings-group">
                        <legend data-i18n="settingsPanel.backend.legend">LLM 后端</legend>
                        <label>
                            <span data-i18n="settingsPanel.backend.current">当前后端</span>
                            <select id="settings-llm-backend">
                                <option value="remote_api" data-i18n="settingsPanel.backend.remote_api">remote_api</option>
                                <option value="local_api" data-i18n="settingsPanel.backend.local_api">local_api</option>
                                <option value="onnxruntime" data-i18n="settingsPanel.backend.onnxruntime">onnxruntime</option>
                                <option value="openvino" data-i18n="settingsPanel.backend.openvino">openvino</option>
                            </select>
                        </label>
                    </fieldset>

                    <fieldset class="settings-group">
                        <legend data-i18n="settingsPanel.remoteApi.legend">Remote API</legend>
                        <div class="settings-grid">
                            <label>
                                <span data-i18n="settingsPanel.remoteApi.apiKey">API Key</span>
                                <input id="settings-remote-api-key" type="password" autocomplete="off">
                            </label>
                            <label>
                                <span data-i18n="settingsPanel.remoteApi.baseUrl">Base URL</span>
                                <input id="settings-remote-base-url" type="text">
                            </label>
                            <label>
                                <span data-i18n="settingsPanel.remoteApi.model">Model</span>
                                <input id="settings-remote-model" type="text">
                            </label>
                        </div>
                    </fieldset>

                    <fieldset class="settings-group">
                        <legend data-i18n="settingsPanel.localApi.legend">Local API</legend>
                        <div class="settings-grid">
                            <label>
                                <span data-i18n="settingsPanel.localApi.apiKey">API Key</span>
                                <input id="settings-local-api-key" type="password" autocomplete="off">
                            </label>
                            <label>
                                <span data-i18n="settingsPanel.localApi.baseUrl">Base URL</span>
                                <input id="settings-local-base-url" type="text">
                            </label>
                            <label>
                                <span data-i18n="settingsPanel.localApi.model">Model</span>
                                <input id="settings-local-model" type="text">
                            </label>
                        </div>
                    </fieldset>

                    <fieldset class="settings-group">
                        <legend data-i18n="settingsPanel.localRuntime.legend">Local Runtime</legend>
                        <div class="settings-grid">
                            <label>
                                <span data-i18n="settingsPanel.localRuntime.model">Model</span>
                                <input id="settings-runtime-model" type="text">
                            </label>
                            <label>
                                <span data-i18n="settingsPanel.localRuntime.modelDir">Model Dir</span>
                                <input id="settings-runtime-model-dir" type="text">
                            </label>
                            <label>
                                <span data-i18n="settingsPanel.localRuntime.npuDevice">NPU Device</span>
                                <input id="settings-runtime-npu-device" type="text">
                            </label>
                            <label>
                                <span data-i18n="settingsPanel.localRuntime.onnxProvider">ONNX Provider</span>
                                <input id="settings-runtime-onnx-provider" type="text">
                            </label>
                            <label class="checkbox-label">
                                <span data-i18n="settingsPanel.localRuntime.requireNpu">Require NPU</span>
                                <input id="settings-runtime-require-npu" type="checkbox">
                            </label>
                        </div>
                    </fieldset>

                    <div class="stack-inline">
                        <button id="reload-settings" type="button" class="btn btn-secondary" data-i18n="settingsPanel.reloadButton">重新读取</button>
                        <button id="save-settings" type="submit" class="btn btn-secondary" data-i18n="settingsPanel.saveButton">保存设置</button>
                    </div>
                    <p id="settings-status" class="settings-status" data-i18n="settingsPanel.waitingStatus">等待读取 app_config...</p>
                </form>
            </section>
        </div>

        <section class="panel fade-in delay-3">
            <h2 data-i18n="auditPanel.title">Audit Status</h2>
            <div class="stack-inline">
                <button id="verify-audit" class="btn btn-secondary" data-i18n="auditPanel.verifyBtn">Audit Integrity Check</button>
                <button id="export-audits" class="btn btn-secondary" data-i18n="auditPanel.exportBtn">Export Audit Report</button>
                <span id="audit-status" class="badge" data-i18n="auditPanel.status.unchecked">Unchecked</span>
            </div>
            <ul id="audit-issues" class="issues"></ul>

            <h2 data-i18n="auditPanel.historyTitle">Recent Audit Records</h2>
            <ul id="audit-list" class="audit-list"></ul>

            <h2 data-i18n="auditPanel.llmTitle">LLM Interface</h2>
            <div class="stack-inline">
                <button id="llm-review-graph" type="button" class="btn btn-secondary" data-i18n="auditPanel.reviewBtn">Review Graph Validity</button>
            </div>
            <pre id="llm-review-response" class="llm-output" data-i18n="auditPanel.waitingReview">Waiting for review...</pre>

            <form id="llm-generate-form" class="stacked-form">
                <label>
                    <span data-i18n="auditPanel.topicLabel">Topic</span>
                    <textarea id="llm-generate-topic" required data-i18n-placeholder="auditPanel.generatePlaceholder" placeholder="Enter a topic for LLM to generate a thinking graph and overwrite the current one"></textarea>
                </label>
                <button type="submit" class="btn btn-secondary" data-i18n="auditPanel.generateBtn">Generate and Overwrite Current Graph</button>
            </form>
            <pre id="llm-generate-response" class="llm-output" data-i18n="auditPanel.waitingGenerate">Waiting for generation...</pre>

            <form id="llm-form" class="stacked-form">
                <label>
                    <span data-i18n="auditPanel.promptLabel">Prompt</span>
                    <textarea id="llm-prompt" required data-i18n-placeholder="auditPanel.promptPlaceholder" placeholder="Ask LLM to break down key opinions and conflicting relationships in this topic"></textarea>
                </label>
                <button type="submit" class="btn" data-i18n="auditPanel.callBtn">Call LLM</button>
            </form>
            <pre id="llm-response" class="llm-output" data-i18n="auditPanel.waitingCall">Waiting for call...</pre>
        </section>
    </main>

    <script src="{{ url_for('static', filename='i18n.js') }}"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
